<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Verifier Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; }
header { background:#2c3e50; color:white; width:100%; padding:15px; text-align:center; }
.container { background:white; padding:20px; border-radius:8px; margin-top:20px; width:90%; max-width:900px; box-shadow:0 0 15px rgba(0,0,0,0.2); }
select, input, button { width:100%; padding:10px; margin:8px 0; border-radius:5px; border:1px solid #ccc; }
button { background:#3498db; color:white; border:none; cursor:pointer; font-weight:bold; }
button:hover { background:#2980b9; }
h2 { text-align:center; margin-bottom:20px; }
table { width:100%; border-collapse: collapse; margin-top:20px; }
th, td { border:1px solid #ccc; padding:10px; text-align:left; }
tr:nth-child(even) { background:#f9f9f9; }
tr:nth-child(odd) { background:#ffffff; }
tr:hover { background:#d0ebff; }
.highlight { background: yellow; font-weight: bold; }
.masked { cursor:pointer; background:#eee; color:#999; text-align:center; }
input[readonly] { background:#eee; }
</style>
</head>
<body>

<header><h1>Verifier Search Portal</h1></header>

<div class="container">
  <label for="sectionSelect">Select Section:</label>
  <select id="sectionSelect">
    <option value="">-- Select --</option>
    <option value="company">Company</option>
    <option value="property">Property</option>
    <option value="vehicle">Vehicle</option>
    <option value="dna_sample">DNA/Sample</option>
    <option value="profession">Profession</option>
  </select>

  <div id="dynamicFields"></div>

  <button id="searchBtn">Search</button>

  <table id="resultsTable">
    <thead></thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// --- Supabase setup ---
const supabaseUrl = 'https://nfixpojxelyrdxxqqvpb.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5maXhwb2p4ZWx5cmR4eHFxdnBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg3MjI0ODYsImV4cCI6MjA3NDI5ODQ4Nn0.X6GmWOzL6NBtKKBejHjf6xQuEBeiA40EOEs4uQt7Vxw';
const supabase = createClient(supabaseUrl, supabaseKey);

const sectionSelect = document.getElementById('sectionSelect');
const dynamicFields = document.getElementById('dynamicFields');
const searchBtn = document.getElementById('searchBtn');
const resultsTable = document.getElementById('resultsTable');
const tableHead = resultsTable.querySelector('thead');
const tableBody = resultsTable.querySelector('tbody');

let currentSection = '';

// --- Fields per section ---
const fieldsPerSection = {
  company: ["company_name", "registration_number", "contact_person"],
  property: ["property_name", "stand_plot_number", "owner_full_name"],
  vehicle: ["vehicle_make", "vehicle_model", "registration_number", "owner_full_name"],
  dna_sample: ["sample_id", "donor_name", "collection_date", "sample_type", "purpose_test_type"],
  profession: ["profession_name", "practitioner_full_name", "license_number", "workplace_name"]
};

// --- Labels per field ---
const labels = {
  company_name: "Company Name",
  registration_number: "Registration Number",
  contact_person: "Contact Person",
  property_name: "Property Name / Title",
  stand_plot_number: "Stand / Plot Number",
  owner_full_name: "Owner Full Name",
  vehicle_make: "Vehicle Make / Brand",
  vehicle_model: "Vehicle Model",
  sample_id: "Sample ID",
  donor_name: "Donor / Suspect Name",
  collection_date: "Collection Date",
  sample_type: "Type of Sample",
  purpose_test_type: "Purpose / Test Type",
  profession_name: "Profession Name / Title",
  practitioner_full_name: "Practitioner Full Name",
  license_number: "License / Certification Number",
  workplace_name: "Workplace / Organization Name"
};

// --- Generate dynamic input fields ---
sectionSelect.addEventListener('change', e => {
  currentSection = e.target.value;
  dynamicFields.innerHTML = '';
  tableHead.innerHTML = '';
  tableBody.innerHTML = '';

  if(!currentSection) return;

  // For DNA, prompt secret code first
  if(currentSection === "dna_sample") {
    const code = prompt("Enter access code to view DNA records:");
    if(code !== "SECRET_CODE") return alert("Access denied!");
  }

  fieldsPerSection[currentSection].forEach(f => {
    const label = document.createElement('label');
    label.textContent = labels[f];
    const input = document.createElement('input');
    input.type = 'text';
    input.id = f;
    input.placeholder = labels[f];
    dynamicFields.appendChild(label);
    dynamicFields.appendChild(input);
  });
});

// --- Search button click ---
searchBtn.addEventListener('click', async () => {
  tableHead.innerHTML = '';
  tableBody.innerHTML = '';

  if(!currentSection) return alert("Please select a section.");

  // Build query object from filled inputs
  const queryObj = {};
  fieldsPerSection[currentSection].forEach(f => {
    const val = document.getElementById(f).value.trim();
    if(val) queryObj[f] = val.toLowerCase();
  });

  let { data, error } = await supabase
    .from(currentSection)
    .select(fieldsPerSection[currentSection].join(','));

  if(error) return alert("Error: " + error.message);

  // Filter data client-side
  if(queryObj && Object.keys(queryObj).length > 0){
    data = data.filter(row => {
      return Object.keys(queryObj).every(k => 
        row[k] && row[k].toString().toLowerCase().includes(queryObj[k])
      );
    });
  }

  if(!data || data.length === 0) return alert("No records found.");

  // Build table headers
  const thRow = document.createElement('tr');
  fieldsPerSection[currentSection].forEach(f => {
    const th = document.createElement('th');
    th.textContent = labels[f];
    thRow.appendChild(th);
  });
  tableHead.appendChild(thRow);

  // Build table body
  data.forEach(row => {
    const tr = document.createElement('tr');
    fieldsPerSection[currentSection].forEach(f => {
      const td = document.createElement('td');
      let value = row[f] ? row[f].toString() : '';

      // Mask DNA fields
      if(currentSection === "dna_sample" && f !== "sample_id" && value){
        const original = value;
        td.textContent = "••••••••";
        td.classList.add("masked");
        td.addEventListener('click', () => {
          td.textContent = td.textContent === "••••••••" ? original : "••••••••";
        });
      } else {
        td.textContent = value;
      }

      tr.appendChild(td);
    });
    tableBody.appendChild(tr);
  });
});
</script>

</body>
</html>
